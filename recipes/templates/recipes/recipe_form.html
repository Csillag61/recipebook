{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>{% if form.instance.pk %}Edit Recipe{% else %}Create Recipe{% endif %}</h2>

  {# Error summary #}
  {% if form.errors or formset.errors or formset.non_form_errors %}
    <div class="alert alert-danger">
      Please fix the errors below.
      {% if formset.non_form_errors %}<div>{{ formset.non_form_errors }}</div>{% endif %}
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    {{ form|crispy }}

    {% if form.instance.pk and form.instance.image %}
      <div class="mb-3">
        <img src="{{ form.instance.image.url }}" alt="{{ form.instance.title }}" class="image-preview">
      </div>
    {% endif %}

    <img id="preview" class="image-preview d-none" src="#" alt="Image preview" aria-live="polite">

    <h4>Ingredients</h4>

    {{ formset.management_form }}

    <div id="ingredient-formset">
      {% for ingredient_form in formset %}
        {# Show existing rows; hide blank extras except the first extra #}
        <div class="border p-3 mb-3 rounded ingredient-form{% if not ingredient_form.instance.pk and not forloop.first %} d-none{% endif %}">
          {% for hidden in ingredient_form.hidden_fields %}{{ hidden }}{% endfor %}
          {% for field in ingredient_form.visible_fields %}
            {{ field|as_crispy_field }}
          {% endfor %}

          {% if ingredient_form.errors %}
            <div class="text-danger small">{{ ingredient_form.errors }}</div>
          {% endif %}

          {% if ingredient_form.can_delete %}
            {{ ingredient_form.DELETE }}
            <button type="button" class="btn btn-sm btn-outline-danger mt-2 ingredient-remove" data-action="remove">
              Remove
            </button>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <div class="d-flex gap-2">
      <button type="button" id="add-ingredient" class="btn btn-secondary">Add Ingredient</button>
      <button type="submit" class="btn btn-primary">
        {% if form.instance.pk %}Update{% else %}Save Recipe{% endif %}
      </button>
      {% if form.instance.pk %}
        <a class="btn btn-outline-secondary" href="{% url 'recipes:recipe_detail' form.instance.pk %}">Cancel</a>
        <a class="btn btn-outline-danger ms-auto" href="{% url 'recipes:recipe_delete' form.instance.pk %}">Deleteâ€¦</a>
      {% else %}
        <a class="btn btn-outline-secondary" href="{% url 'recipes:recipe_list' %}">Cancel</a>
      {% endif %}
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Image preview for newly chosen file
    const fileInput = document.querySelector('input[type="file"]');
    if (fileInput) {
      fileInput.addEventListener('change', function (event) {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        const preview = document.getElementById('preview');
        if (!preview) return;
        preview.src = URL.createObjectURL(file);
        preview.classList.remove('d-none');
      });
    }

    // Add next hidden ingredient row
    const addBtn = document.getElementById('add-ingredient');
    const container = document.getElementById('ingredient-formset');

    function nextHiddenRow() {
      return Array.from(container.querySelectorAll('.ingredient-form')).find(el => el.classList.contains('d-none'));
    }

    addBtn?.addEventListener('click', function () {
      const row = nextHiddenRow();
      if (row) {
        row.classList.remove('d-none');
      } else {
        addBtn.setAttribute('disabled', 'disabled');
      }
    });

    // Remove (mark DELETE for existing; hide/clear for blank)
    container.addEventListener('click', function (e) {
      const btn = e.target.closest('button.ingredient-remove');
      if (!btn) return;

      const row = btn.closest('.ingredient-form');
      if (!row) return;

      const deleteInput = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (deleteInput) {
        deleteInput.checked = true;
        row.classList.add('d-none');
      } else {
        row.querySelectorAll('input, select, textarea').forEach(el => {
          if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
          else el.value = '';
        });
        row.classList.add('d-none');
      }
      addBtn?.removeAttribute('disabled');
    });
  });
</script>
{% endblock %}
